import{D as O,E as b,F as N,d as D,p as k}from"./main-C4QD6_it.js";import{A as U,U as h,o as j}from"./type-3H5uNriJ.js";import"./wScoge-BfExBSv1.js";import"./i49-DSyJwZGj.js";async function B(i,e){return await i({method:"eth_sendRawTransaction",params:[e]})}const G="/sdk/2022-08-12/embedded-wallet",p=i=>`thirdwebEwsWalletUserId-${i}`,M="walletToken",w=i=>`${M}-${i}`,L=i=>`passkey-credential-id-${i}`,R="a",m=(i,e)=>`${R}-${i}-${e}`,v=i=>`walletConnectSessions-${i}`,E=new Map;class g{constructor({clientId:e}){Object.defineProperty(this,"isSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isSupported=typeof window<"u"&&!!window.localStorage,this.clientId=e}async getItem(e){return this.isSupported?window.localStorage.getItem(e):E.get(e)??null}async setItem(e,t){if(this.isSupported)return window.localStorage.setItem(e,t);E.set(e,t)}async removeItem(e){const t=await this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1}async getWalletConnectSessions(){return this.getItem(v(this.clientId))}async saveWalletConnectSessions(e){await this.setItem(v(this.clientId),e)}async savePasskeyCredentialId(e){await this.setItem(L(this.clientId),e)}async getPasskeyCredentialId(){return this.getItem(L(this.clientId))}async saveAuthCookie(e){await this.setItem(w(this.clientId),e)}async getAuthCookie(){return this.getItem(w(this.clientId))}async removeAuthCookie(){return this.removeItem(w(this.clientId))}async saveDeviceShare(e,t){await this.saveWalletUserId(t),await this.setItem(m(this.clientId,t),e)}async getDeviceShare(){const e=await this.getWalletUserId();return e?this.getItem(m(this.clientId,e)):null}async removeDeviceShare(){const e=await this.getWalletUserId();return e?this.removeItem(m(this.clientId,e)):!1}async getWalletUserId(){return this.getItem(p(this.clientId))}async saveWalletUserId(e){await this.setItem(p(this.clientId),e)}async removeWalletUserId(){return this.removeItem(p(this.clientId))}}function f(i){return new Promise(e=>{setTimeout(e,i*1e3)})}const V={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},y=new Map;class K{constructor({link:e,baseUrl:t,iframeId:a,container:s=document.body,onIframeInitialize:r}){Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.iframeBaseUrl=t;let n=document.getElementById(a);const o=new URL(e);if(!n||n.src!==o.href){if(!n){n=document.createElement("iframe");const c={...V};Object.assign(n.style,c),n.setAttribute("id",a),n.setAttribute("fetchpriority","high"),s.appendChild(n)}n.src=o.href;const l=c=>{if(c.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",l),!n){console.warn("thirdweb Iframe not found");return}this.onIframeLoadHandler(n,r)()}};window.addEventListener("message",l)}this.iframe=n}async onIframeLoadedInitVariables(){return{}}onIframeLoadHandler(e,t){return async()=>{var n;const a=new MessageChannel,s=new Promise((o,l)=>{a.port1.onmessage=c=>{const{data:u}=c;a.port1.close(),u.success||l(new Error(u.error)),y.set(e.src,!0),t&&t(),o(!0)}});(n=e==null?void 0:e.contentWindow)==null||n.postMessage({eventType:"initIframe",data:await this.onIframeLoadedInitVariables()},this.iframeBaseUrl,[a.port2]),await s}}async call({procedureName:e,params:t,showIframe:a=!1}){var n;for(;!y.get(this.iframe.src);)await f(this.POLLING_INTERVAL_SECONDS);a&&(this.iframe.style.display="block",await f(.005));const s=new MessageChannel,r=new Promise((o,l)=>{s.port1.onmessage=async c=>{const{data:u}=c;s.port1.close(),a&&(await f(.1),this.iframe.style.display="none"),u.success?o(u.data):l(new Error(u.error))}});return(n=this.iframe.contentWindow)==null||n.postMessage({eventType:e,data:t},this.iframeBaseUrl,[s.port2]),r}destroy(){y.delete(this.iframe.src)}}class $ extends K{constructor({clientId:e,baseUrl:t}){super({iframeId:q,link:Q({clientId:e,path:G,baseUrl:t}).href,baseUrl:t,container:document.body}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.clientId=e}async onIframeLoadedInitVariables(){const e=new g({clientId:this.clientId});return{authCookie:await e.getAuthCookie(),deviceShareStored:await e.getDeviceShare(),walletUserId:await e.getWalletUserId(),clientId:this.clientId}}}function Q({clientId:i,baseUrl:e,path:t,queryParams:a}){var r;const s=new URL(`${t}`,e);if(a)for(const n of Object.keys(a))s.searchParams.set(n,((r=a[n])==null?void 0:r.toString())||"");return s.searchParams.set("clientId",i),s}const q="thirdweb-in-app-wallet-iframe";class F{constructor({baseUrl:e,querier:t,preLogin:a,postLogin:s,client:r}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=t,this.preLogin=a,this.postLogin=s,this.client=r}async sendEmailLoginOtp({email:e}){return await this.preLogin(),await this.LoginQuerier.call({procedureName:"sendThirdwebEmailLoginOtp",params:{email:e}})}async sendSmsLoginOtp({phoneNumber:e}){return await this.preLogin(),await this.LoginQuerier.call({procedureName:"sendThirdwebSmsLoginOtp",params:{phoneNumber:e}})}}class H extends F{constructor(){super(...arguments),Object.defineProperty(this,"closeWindow",{enumerable:!0,configurable:!0,writable:!0,value:({isWindowOpenedByFn:e,win:t,closeOpenedWindow:a})=>{e?t==null||t.close():t&&a?a(t):t&&t.close()}})}async getOauthLoginUrl(e){return await this.LoginQuerier.call({procedureName:"getHeadlessOauthLoginLink",params:{authProvider:e}})}async loginWithModal(){await this.preLogin();const e=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:void 0,showIframe:!0});return this.postLogin(e)}async loginWithEmailOtp({email:e}){await this.preLogin();const t=await this.LoginQuerier.call({procedureName:"loginWithThirdwebModal",params:{email:e},showIframe:!0});return this.postLogin(t)}getOauthPopUpSizing(e){switch(e){case U.FACEBOOK:return"width=715, height=555";default:return"width=350, height=500"}}async loginWithOauth(e){let t=e==null?void 0:e.openedWindow,a=!1;if(t||(t=window.open("","Login",this.getOauthPopUpSizing(e.oauthProvider)),a=!0),!t)throw new Error("Something went wrong opening pop-up");const[{loginLink:s}]=await Promise.all([this.getOauthLoginUrl(e.oauthProvider),this.preLogin()]);t.location.href=s;const r=await new Promise((n,o)=>{const l=window.setInterval(async()=>{t&&t.closed&&(clearInterval(l),window.removeEventListener("message",c),o(new Error("User closed login window")))},1e3),c=async u=>{if(u.origin===this.baseUrl){if(typeof u.data!="object"){o(new Error("Invalid event data"));return}switch(u.data.eventType){case"userLoginSuccess":{window.removeEventListener("message",c),clearInterval(l),this.closeWindow({isWindowOpenedByFn:a,win:t,closeOpenedWindow:e==null?void 0:e.closeOpenedWindow}),u.data.authResult&&n(u.data.authResult);break}case"userLoginFailed":{window.removeEventListener("message",c),clearInterval(l),this.closeWindow({isWindowOpenedByFn:a,win:t,closeOpenedWindow:e==null?void 0:e.closeOpenedWindow}),o(new Error(u.data.error));break}case"injectDeveloperClientId":{t==null||t.postMessage({eventType:"injectDeveloperClientIdResult",developerClientId:this.client.clientId,authOption:e.oauthProvider},this.baseUrl);break}}}};window.addEventListener("message",c)});return this.postLogin({storedToken:{...r.storedToken,shouldStoreCookieString:!0},walletDetails:{...r.walletDetails,isIframeStorageEnabled:!1}})}async loginWithCustomJwt({encryptionKey:e,jwt:t}){await this.preLogin();const a=await this.LoginQuerier.call({procedureName:"loginWithCustomJwt",params:{encryptionKey:e,jwt:t}});return this.postLogin(a)}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:t}){await this.preLogin();const a=await this.LoginQuerier.call({procedureName:"loginWithCustomAuthEndpoint",params:{encryptionKey:e,payload:t}});return this.postLogin(a)}async verifyEmailLoginOtp({email:e,otp:t,recoveryCode:a}){const s=await this.LoginQuerier.call({procedureName:"verifyThirdwebEmailLoginOtp",params:{email:e,otp:t,recoveryCode:a}});return this.postLogin(s)}async verifySmsLoginOtp({phoneNumber:e,otp:t,recoveryCode:a}){const s=await this.LoginQuerier.call({procedureName:"verifyThirdwebSmsLoginOtp",params:{phoneNumber:e,otp:t,recoveryCode:a}});return this.postLogin(s)}}class J{constructor({client:e,querier:t,onAuthSuccess:a,baseUrl:s}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.AuthQuerier=t,this.localStorage=new g({clientId:e.clientId}),this.onAuthSuccess=a,this.BaseLogin=new H({postLogin:async r=>this.postLogin(r),preLogin:async()=>{await this.preLogin()},querier:t,client:e,baseUrl:s})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString),await this.onAuthSuccess({storedToken:e,walletDetails:t})}async loginWithAuthToken(e,t){await this.preLogin();const a=await this.AuthQuerier.call({procedureName:"loginWithStoredTokenDetails",params:{storedToken:e.storedToken,recoveryCode:t}});return this.postLogin(a)}async loginWithModal(){return this.BaseLogin.loginWithModal()}async loginWithEmailOtp(e){return this.BaseLogin.loginWithEmailOtp(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async loginWithOauth(e){return this.BaseLogin.loginWithOauth(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async sendSmsLoginOtp({phoneNumber:e}){return this.BaseLogin.sendSmsLoginOtp({phoneNumber:e})}async verifyEmailLoginOtp(e){return this.BaseLogin.verifyEmailLoginOtp(e)}async verifySmsLoginOtp(e){return this.BaseLogin.verifySmsLoginOtp(e)}async logout(){const{success:e}=await this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=await this.localStorage.removeAuthCookie(),a=await this.localStorage.removeWalletUserId();return{success:e||t||a}}}function S(i){return Uint8Array.from(i,e=>e.charCodeAt(0)).buffer}function Z(i){return String.fromCharCode(...new Uint8Array(i))}function T(i){return i.match(/^[a-zA-Z0-9\-_]+=*$/)!==null}function d(i){return btoa(Z(i)).replaceAll("+","-").replaceAll("/","_")}function I(i){return i=i.replaceAll("-","+").replaceAll("_","/"),S(atob(i))}async function z(i){return await crypto.subtle.digest("SHA-256",i)}function P(){return!!window.PublicKeyCredential}async function W(){return await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()}async function x(i){if(i==="local")return"platform";if(i==="roaming"||i==="extern")return"cross-platform";if(i!=="both")try{return await W()?"platform":"cross-platform"}catch{return}}function X(i){switch(i){case-7:return"ES256";case-257:return"RS256";default:throw new Error(`Unknown algorithm code: ${i}`)}}async function Y(i,e,t){if(t=t??{},!T(e))throw new Error("Provided challenge is not properly encoded in Base64url");const a={challenge:I(e),rp:{id:t.domain??window.location.hostname,name:t.domain??window.location.hostname},user:{id:t.userHandle?S(t.userHandle):await z(new TextEncoder().encode("passwordless.id-user:"+i)),name:i,displayName:i},pubKeyCredParams:[{alg:-7,type:"public-key"},{alg:-257,type:"public-key"}],timeout:t.timeout??6e4,authenticatorSelection:{userVerification:t.userVerification??"required",authenticatorAttachment:await x(t.authenticatorType??"auto"),residentKey:t.discoverable??"preferred",requireResidentKey:t.discoverable==="required"},attestation:"direct"};t.debug&&console.debug(a);const s=await navigator.credentials.create({publicKey:a});t.debug&&console.debug(s);const r=s.response;let n={username:i,credential:{id:s.id,publicKey:d(r.getPublicKey()),algorithm:X(s.response.getPublicKeyAlgorithm())},authenticatorData:d(r.getAuthenticatorData()),clientData:d(r.clientDataJSON)};return t.attestation&&(n.attestationData=d(r.attestationObject)),n}async function ee(i){const e=["internal"],t=["hybrid","usb","ble","nfc"];if(i==="local")return e;if(i=="roaming"||i==="extern")return t;if(i==="both")return[...e,...t];try{return await W()?e:t}catch{return[...e,...t]}}async function te(i,e,t){if(t=t??{},!T(e))throw new Error("Provided challenge is not properly encoded in Base64url");const a=await ee(t.authenticatorType??"auto");let s={challenge:I(e),rpId:t.domain??window.location.hostname,allowCredentials:i.map(l=>({id:I(l),type:"public-key",transports:a})),userVerification:t.userVerification??"required",timeout:t.timeout??6e4};t.debug&&console.debug(s);let r=await navigator.credentials.get({publicKey:s,mediation:t.mediation});t.debug&&console.debug(r);const n=r.response;return{credentialId:r.id,authenticatorData:d(n.authenticatorData),clientData:d(n.clientDataJSON),signature:d(n.signature),userHandle:n.userHandle?d(n.userHandle):void 0}}new TextDecoder("utf-8");function _(){return`${b("inAppWallet")}/api/2024-05-05/login/passkey/callback`}function C(i,e){return`${b("inAppWallet")}/api/2024-05-05/login/passkey?type=${i}${e?`&username=${e}`:""}`}async function ie(i){if(!P())throw new Error("Passkeys are not available on this device");const e=new g({clientId:i.client.clientId}),t=O(i.client),a=i.username??re(),r=await(await t(C("sign-up",a))).json();if(!r.challenge)throw new Error("No challenge received");const n=r.challenge,o=await Y(a,n,{authenticatorType:i.authenticatorType??"auto",userVerification:"required",attestation:!0,debug:!1});await e.savePasskeyCredentialId(o.credential.id);const c=await(await t(_(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"sign-up",authenticatorData:o.authenticatorData,credentialId:o.credential.id,serverVerificationId:r.serverVerificationId,clientData:o.clientData,username:a,credential:{publicKey:o.credential.publicKey,algorithm:o.credential.algorithm}})})).json();if(!c)throw new Error("No token received");return c}async function ae(i){if(!P())throw new Error("Passkeys are not available on this device");const e=new g({clientId:i.client.clientId}),t=O(i.client),s=await(await t(C("sign-in"))).json();if(!s.challenge)throw new Error("No challenge received");const r=s.challenge,n=await e.getPasskeyCredentialId(),l=await te(n?[n]:[],r,{authenticatorType:i.authenticatorType??"auto",userVerification:"required"}),c=await t(_(),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"sign-in",authenticatorData:l.authenticatorData,credentialId:l.credentialId,serverVerificationId:s.serverVerificationId,clientData:l.clientData,signature:l.signature})});await e.savePasskeyCredentialId(l.credentialId);const u=await c.json();if(!u)throw new Error("No token received");return u}function re(){return`wallet-${new Date().toISOString()}`}class ne{constructor({client:e,querier:t}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.walletManagerQuerier=t,this.localStorage=new g({clientId:e.clientId})}async postWalletSetUp({deviceShareStored:e,walletAddress:t,isIframeStorageEnabled:a,walletUserId:s}){return a||await this.localStorage.saveDeviceShare(e,s),{walletAddress:t}}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status===h.LOGGED_IN_WALLET_INITIALIZED?{status:h.LOGGED_IN_WALLET_INITIALIZED,...e.user,account:await this.getAccount()}:e.status===h.LOGGED_IN_NEW_DEVICE?{status:h.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:e.status===h.LOGGED_IN_WALLET_UNINITIALIZED?{status:h.LOGGED_IN_WALLET_UNINITIALIZED,...e.user}:{status:e.status}}async getAccount(){const e=this.walletManagerQuerier,{address:t}=await e.call({procedureName:"getAddress",params:void 0}),a=async r=>{const n={to:r.to??void 0,data:r.data,value:r.value,gasLimit:r.gas,nonce:r.nonce,chainId:r.chainId};r.maxFeePerGas?(n.accessList=r.accessList,n.maxFeePerGas=r.maxFeePerGas,n.maxPriorityFeePerGas=r.maxPriorityFeePerGas,n.type=2):(n.gasPrice=r.gasPrice,n.type=0);const{signedTransaction:o}=await e.call({procedureName:"signTransaction",params:{transaction:n,chainId:r.chainId,rpcEndpoint:`https://${r.chainId}.rpc.thirdweb.com`}});return o},s=this.client;return{address:t,async signTransaction(r){if(!r.chainId)throw new Error("chainId required in tx to sign");return a({...r,chainId:r.chainId})},async sendTransaction(r){const n=N({client:s,chain:D(r.chainId)}),o=await a(r);return{transactionHash:await B(n,o)}},async signMessage({message:r}){const n=typeof r=="string"?r:r.raw,{signedMessage:o}=await e.call({procedureName:"signMessage",params:{message:n,chainId:1}});return o},async signTypedData(r){var u;const n=k(r);(u=n.types)!=null&&u.EIP712Domain&&(n.types.EIP712Domain=void 0);const o=n.domain,l=(o==null?void 0:o.chainId)||1,{signedTypedData:c}=await e.call({procedureName:"signTypedDataV4",params:{domain:{chainId:l,verifyingContract:o==null?void 0:o.verifyingContract,name:o==null?void 0:o.name,version:o==null?void 0:o.version},types:n.types,message:n.message,chainId:l,rpcEndpoint:`https://${l}.rpc.thirdweb.com`}});return c}}}}class ue{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor({client:e,onAuthSuccess:t}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const a=b("inAppWallet");this.client=e,this.querier=new $({clientId:e.clientId,baseUrl:a}),this.wallet=new ne({client:e,querier:this.querier}),this.auth=new J({client:e,querier:this.querier,baseUrl:a,onAuthSuccess:async s=>(t==null||t(s),await this.wallet.postWalletSetUp({...s.walletDetails,walletUserId:s.storedToken.authDetails.userWalletId}),await this.querier.call({procedureName:"initIframe",params:{deviceShareStored:s.walletDetails.deviceShareStored,clientId:this.client.clientId,walletUserId:s.storedToken.authDetails.userWalletId,authCookie:s.storedToken.cookieString}}),{user:{status:h.LOGGED_IN_WALLET_INITIALIZED,authDetails:s.storedToken.authDetails,account:await this.wallet.getAccount(),walletAddress:s.walletDetails.walletAddress}})})}async getUser(){return this.wallet.getUserWalletStatus()}getAccount(){return this.wallet.getAccount()}async preAuthenticate(e){const t=e.strategy;switch(t){case"email":return this.auth.sendEmailLoginOtp({email:e.email});case"phone":return this.auth.sendSmsLoginOtp({phoneNumber:e.phoneNumber});default:A(t,`Provider: ${t} doesnt require pre-authentication`)}}async authenticate(e){const t=e.strategy;switch(t){case"email":return await this.auth.verifyEmailLoginOtp({email:e.email,otp:e.verificationCode});case"phone":return await this.auth.verifySmsLoginOtp({otp:e.verificationCode,phoneNumber:e.phoneNumber});case"apple":case"facebook":case"google":{const a=j[t];return this.auth.loginWithOauth({oauthProvider:a,closeOpenedWindow:e.closeOpenedWindow,openedWindow:e.openedWindow})}case"jwt":return this.auth.loginWithCustomJwt({jwt:e.jwt,encryptionKey:e.encryptionKey});case"auth_endpoint":return this.auth.loginWithCustomAuthEndpoint({payload:e.payload,encryptionKey:e.encryptionKey});case"iframe_email_verification":return this.auth.loginWithEmailOtp({email:e.email});case"iframe":return this.auth.loginWithModal();case"passkey":{if(e.type==="sign-up"){const s=await ie({client:e.client,authenticatorType:e.authenticatorType,username:e.passkeyName});return this.auth.loginWithAuthToken(s)}const a=await ae({client:e.client,authenticatorType:e.authenticatorType});return this.auth.loginWithAuthToken(a)}default:A(t)}}async logout(){return await this.auth.logout()}}function A(i,e){throw new Error(e??`Invalid param: ${i}`)}export{ue as InAppWebConnector};
